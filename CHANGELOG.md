# Changelog

All notable changes to Bastion AI Workspace will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [0.20.0] - 2025-02-15
- Update: Bump version to 0.20.0 across application and Docker

## [0.16.0] - 2025-01-XX
- Feature: Import generated images into the document library
- Refactor: Simplify fiction agent
- Fix: Prompt multiplication bloat in Fiction agent
- Feature: ePub export (untested)
- Feature: 'Cover' frontmatter type support in Fiction documents

## [Unreleased]
- Fix: Skill loading idempotency — load_all_skills() guarded so safe to call multiple times; grpc_service uses _ensure_skills_loaded() to avoid re-registering 33 skills on every request
- Feature: Ranked routing with fallback stack — skill selector returns top-3 ranked skills; on task_status=rejected orchestration retries with next fallback (no extra LLM call); help/define short-circuits get default fallbacks
- Feature: Ranked routing with fallback stack — skill selector returns top-3 ranked skills; on rejected, orchestration retries with next fallback (no extra LLM call); help/define short-circuits get default fallbacks
- Feature: Help-to-Research handoff when help skill detects out-of-scope question (domain knowledge); routing scopes help to application-only
- Feature: Agent Factory design document and technical implementation guide — comprehensive plan for user-defined research agents with declarative data source connectors, composable skills/playbooks, configurable output destinations (documents, folders, Data Workspace tables, knowledge graph), entity resolution pipeline, knowledge accumulation loop, and AI-powered Assembly Agent; supersedes Data Workspace Analytics Enhancements
- Feature: Agent Factory step I/O contracts — typed input/output schemas for all actions and connector endpoints; Workflow Composer uses contracts for visual step wiring with type checking; built-in action I/O registry; step linking validation at save time
- Feature: Agent Factory @mention invocation — custom agents have unique @handles; users type @handle in chat to invoke; sidebar shows My Agents panel with quick-action buttons; no auto-routing for custom agents
- Feature: Agent Factory work journal — agents maintain a persistent human-readable activity log; users can ask agents about past work; write_journal_entry and query_journal tools; journal entries searchable by date, entity, and status
- Feature: Agent Factory team integration — agents can be shared with teams; configurable team file and post access; team tools (search_team_files, write_team_post, summarize_team_thread); team journal visibility with scoped access; credential isolation preserved
- Feature: Agent Factory monitor mode — periodic change-aware polling (heartbeat pattern); detection tools (detect_new_files, detect_folder_changes, detect_new_data, detect_new_team_posts, detect_new_entities) with persistent watermarks; smart suppression when nothing changed; Celery Beat integration
- Feature: Agent Factory examples document — 16 end-to-end use cases covering all patterns (deterministic pipelines, LLM-augmented research, hybrid investigations, scheduled reports, folder monitors, API monitors, team discussion summarizers, image classifiers, meeting minutes task extractor); decision guide for choosing patterns
- Feature: Agent Factory tool catalog document — comprehensive inventory of 81 tools across 12 categories (file operations, search, task management, notifications, knowledge graph, data workspace, text processing, web, email, monitor, agent internal, external integrations); typed I/O contracts for all tools; scope-aware access control for file operations
- Feature: Agent Factory modular plugin registry — BaseToolPlugin interface for external integrations; PluginLoader with auto-discovery; plugin I/O contracts registered in action registry; database tables for plugin config; API endpoints for plugin management
- Feature: Agent Factory external integrations — Trello (6 tools), Notion (6 tools), Slack (3 tools), CalDAV (4 tools) plugin definitions with full I/O contracts; extensible to GitHub, Jira, Google Sheets, Airtable
- Feature: Agent Factory notification and messaging tools — send_notification (in-app), send_channel_message (Telegram/Discord/Slack via connections-service), broadcast_to_team; granular task management tools (update_todo, complete_todo, search_todos); granular file operations (delete_file, move_file, copy_file)
- Feature: Agent Factory workflow composition model — agents compose from three step types (deterministic tools, LLM tasks, approval gates) in any mix; three execution modes (deterministic/LLM-augmented/hybrid); three run contexts (interactive/background/scheduled); approval gates with LangGraph interrupt_before for interactive and PostgreSQL notification queue for background
- Fix: Gate electronics skill to active editor (requires_editor=True) so technical questions without an electronics doc open route to research
- Fix: Frontmatter stripping only removes leading YAML block (use \\A anchor) so manuscript scene breaks (---) are never stripped; fixes whole-manuscript analysis losing middle chapters
- Feature: Paragraph-numbered two-phase fiction editing — editing existing chapters uses Phase 1 (identify paragraphs to change) and Phase 2 (batched rewrites); system-extracted original_text eliminates anchor hallucination; new chapter generation unchanged
- Fix: Fiction request-type detection — queries with action words (revise, edit, fix, improve, etc.) route to edit path and produce editor operations even when phrased as questions; pure informational questions stay question-only
- Fix: Fiction editor granularity — align 10-20 word guidance in generation subgraph with system prompt; clarify replacement-text completeness; add cross-chapter edit guard (original_text/anchor_text must not span chapter boundaries)
- Feature: Two-pass article (non-fiction) generation — keyword "two-pass" in article/substack/blog requests runs draft pass (raw article text) then refinement pass with style guide and outline for compliance
- Feature: Two-pass chapter generation for fiction — keyword "two-pass" when creating a new chapter runs draft pass (creative prose only) then refinement pass (tighten, style compliance, ManuscriptEdit JSON)
- Fix: Fiction generation subgraph preserves invalid_anchor_operations in shared_memory so self-heal and merge nodes receive them when top-level state key is dropped
- Fix: Fiction whole-story intent uses negative guards so edit/revise/rewrite and "this chapter" keep chapter scope; remove generic whole-story phrases (discrepancies, cohesive, overall)
- Fix: Strip ManuscriptEdit JSON from conversation history in fiction editing subgraphs so LLM does not recycle stale original_text anchors
- Update: Electronics agent suggests new reference files (suggested_files in response) instead of auto-creating them; content routing and save nodes no longer create files
- Fix: Capture-to-inbox uses org_capture only (no research) unless user explicitly asks for research first; inbox is for short idea capture
- Fix: org_capture skill uses prior_step_*_response from shared_memory when run as step 2 in a compound plan so the researched content is captured, not the user's short phrase
- Feature: org_capture converts research and prior-step content to org-mode syntax (headings, bold/italic, tables, lists) for neat inbox entries
- Fix: File relation graph restricted to current user's My Documents only; RLS role forced to user and all queries filter by user_id so nodes/links never leak across users
- Feature: "Craft the next chapter" / "Write next chapter" — resolves target from cursor position (e.g. cursor in Ch1 → generate Ch2)
- Fix: Honor explicit "craft/generate Chapter N" over cursor position when that chapter does not exist yet (e.g. "Craft Chapter 2" with only Chapter 1 in manuscript)
- Feature: Obsidian-style file relation cloud (link graph) with RLS-secured document_links, tab and fullscreen UI, backfill endpoint
- Feature: Download my Library button zips and downloads My Documents folder/file structure
- Update: Overhauled fiction generation prompting — Style Guide elevated as primary creative authority, outline reframed as story ingredients not a recipe, added scene-thinking instructions to prevent beat-by-beat expansion
- Fix: Improved skill routing for editor-context queries to prevent compound plan false positives
- Fix: Enhanced fiction_editing skill description to include analyze/review capabilities
- Fix: Narrowed story_analysis skill to writing theory/concepts (not manuscript review)
- Fix: Added editor-context-takes-precedence-over-continuity guidance to skill selection
- Update: Skills architecture design — add Phase 7 (Compound Query Planner), Phase 8 (Tool Packs), Phase 9 (Hierarchical Selection), new tools/skills roadmap, OpenClaw comparison
- Fix: Skill dispatch (unified_dispatch) routes electronics, general_project, podcast_script to dedicated agents instead of Writing Assistant; Writing Assistant only when active_editor present
- Fix: Skill selection prefers research for how-to questions when no editor; research skill description/keywords include how do I, how to, how can I
- Refactor: Fiction only via Writing Assistant; remove standalone fiction_editing_agent workflow and dispatch; remove build_context_preparation_subgraph and build_resolution_subgraph; fiction_editing_subgraph unchanged
- Refactor: Remove standalone agents (outline, character, rules, style, article); routing and labels use Writing Assistant only; subgraphs unchanged
- Refactor: Disable technical hyperspace agent; /hyperspace and cached technical_hyperspace route to chat (implementation plan kept in docs/dev-notes)
- Fix: Include structured images in research complete chunk when using skill dispatch (unified_dispatch)
- Fix: Route local collection queries (e.g. Dilbert comics, photos of X) to research skill instead of entertainment
- Fix: Org content agent now correctly routes via AUTOMATION skill instead of CONVERSATIONAL (prefer editor with org file open now works)
- Fix: Fiction chapter generation state flow — return validated_operations from generation subgraph merge node for resolution subgraph, fix duplicate system_prompt key overwriting in build_generation_prompt_node
- Fix: Fiction chapter generation – normalize single-operation LLM response in validate_generated_output_node, preserve manuscript/context in _detect_request_type_node early return, always return editor_operations/manuscript_edit from fiction format_response for Writing Assistant
- Refactor: LLM-primary skill routing — filter_eligible (hard gates) + llm_select_skill (descriptions); remove keyword scoring and domain detection
- Refactor: Remove standalone proofreading_agent; proofreading remains as subgraph in fiction_editing, article_writing, podcast_script
- Refactor: Remove standalone rules_editing_agent; rules editing handled by Writing Assistant → rules_editing_subgraph only
- Fix: Faster new AI chat creation (prime cache, skip checkpoint for new conversations, skip redundant refetch)
- Fix: Clarified structured image pattern - frontend uses EITHER structured images OR markdown, not both (prevents duplicate display)
- Feature: Migration 040 adds external_connections, connection_sync_state, connection_data_cache, system_settings for existing DBs (OAuth / email / chat bots)
- Feature: Passive security analysis agent (exposed files, headers, info disclosure) via Tools Service and LLM Orchestrator
- Feature: URL in AI chat sidebar extracts single linked page by default; full-site crawl only when user says crawl/capture/ingest/scrape
- Feature: Route fiction documents through Writing Assistant Agent via unified fiction_editing_subgraph; intent classifier routes type: fiction to writing_assistant_agent
- Refactor: Remove standalone article_writing_agent and character_development_agent; article/character flows use Writing Assistant subgraphs only
- Documentation: Added Technical Hyperspace Implementation Plan for multi-domain simulation system
- Documentation: Added comprehensive Data Workspace Analytics Enhancements planning document covering 4 phases of advanced pattern detection, correlation discovery, and real-time analytics
- Feature: Image search runs hybrid (user + global) when user_id is set; regular users see their images and Global
- Feature: Collection search results show Why it matches and full description in a modal (Read more)
- Fix: Duplicate date removed from collection result captions (title already contains date)
- Fix: Folder delete from disk (file watcher) now uses explicit admin RLS context for global folders
- Fix: Images now display from local document searches via structured metadata transmission
- Fix: PostgreSQL full-text search fallback with automatic stemming (handles brain/brains, dog/dogs plurals)
- Fix: Text search fallback now allows documents with empty type field (database sync issue workaround)
- Fix: Document repository no longer overwrites metadata_json with quality_metrics during INSERT
- Fix: Image metadata now stores both 'type' and 'image_type' keys for reliable search filtering
- Fix: ImageSidecarService now uses correct fetch_one() import, preventing duplicate document creation
- Fix: ImageSidecarService now uses correct column name 'processing_status' instead of 'status'
- Debug: Enhanced vector search logging to diagnose embedding/retrieval issues
- Fix: Vector deletion timeouts when deleting multiple files - added semaphore to limit concurrent deletions to 5, retry logic with exponential backoff for CANCELLED errors, and increased timeout to 120s
- Fix: gRPC keepalive configuration prevents connection drops during bulk vector operations
- Feature: LLM-powered query classification for research agent (collection_search, factual_query, exploratory_search) with fast paths
- Feature: Collection search subgraph with rich metadata descriptions (title, date, series, author, content, tags)
- Feature: Improved image search with canonical content_type handling (comics->comic, photos->photo)
- **BREAKING**: Image search now uses `/api/documents/{id}/file` endpoint instead of hardcoded paths (images served from actual document location)
- Fix: Image search exact match fallback now only triggers with explicit date filter (prevents random results)
- Fix: Image search returns "no results" when concept doesn't match, instead of random comics from series
- Fix: Removed hardcoded directory structure assumptions - images use document folder structure
- Fix: Changed image-vision-service host port from 50056 to 50057 to avoid port conflict
- Feature: Research agent fast path now returns rich item details (title/filename, content preview) and standardized image emission
- Update: Fast path builds structured_images from image documents when image search returns none; response includes markdown images for Chat Sidebar
- Update: Chat Sidebar image URL handling supports /api/documents/{id}/file for research result images
- Feature: Research agent three-tier routing (fast/standard/web) for simple existence queries
- Update: Fast path skips query expansion, sufficiency check, visualization, and full doc analysis
- Update: Query expansion skipped for simple queries (<=5 words)
- Update: Image query analyzer skipped for simple existence queries and cached for parallel searches
- Update: Visualization skipped for simple queries (short query and short response)
- Fix: Fast path returns structured_images and image_search_results for display
- Feature: Benchmark tests for research tier routing (test_research_tier_routing.py)
- Feature: Extended image metadata schema with type-specific fields (location, event, medium, body_part, modality, map_type, coordinates, application, platform)
- Update: Enhanced Edit Image Metadata UI to show type-specific fields based on image type selection
- Update: Image metadata sidecars now support richer searchability for photos, artwork, medical images, maps, and screenshots
- Fix: CRITICAL - Character development subgraph conversation history fallback was too aggressive (triggered at <200 chars), causing recreation of entire profiles instead of adding to existing content
- Fix: Changed character subgraph conversation history threshold from <200 chars to ==0 (completely empty files only)
- Fix: Added comprehensive debug logging to character development subgraph for content tracking
- Fix: CRITICAL - Changed guidance from "replace ENTIRE bullet list" to "replace ONLY THE LAST BULLET" for surgical precision
- Fix: CRITICAL - Updated all subgraphs (rules, style, character, outline) with surgical bullet addition guidance (1-2 bullets max in original_text)
- Fix: CRITICAL - Added validation warnings for overly broad replace_range operations (5+ bullets, 500+ chars) to prevent deleting headings/unrelated content
- Fix: CRITICAL - Enhanced _validate_operation_for_bullet_lists() to detect both insert_after violations AND overly broad replacements
- Fix: CRITICAL - Updated decision trees, examples, and guidance to emphasize surgical approach: "Only include what you need to modify"
- Fix: CRITICAL - Added programmatic enforcement in rules_editing_subgraph to REJECT insert_after operations with bullet content
- Fix: CRITICAL - Created _validate_operation_for_bullet_lists() function that detects and blocks forbidden insert_after+bullet combinations before resolution
- Fix: CRITICAL - Prohibited insert_after for bullet list additions across all writing subgraphs (rules, style, outline, character)
- Fix: Enhanced editor operation prompts with decision tree showing correct approach: replace entire bullet list with expanded version using replace_range
- Fix: Updated 4 subgraphs (rules, style, outline, character) to enforce replace_range for bullet additions - eliminates middle-insertion issue at source
- Fix: Added comprehensive visual examples showing WHY insert_after fails for bullets (picks wrong anchor → splits list) vs WHY replace_range succeeds (clean expansion)
- Fix: CRITICAL - Implemented programmatic section boundary detection in rules_editing_subgraph to prevent insertions in the middle of sections
- Feature: Rules subgraph now automatically corrects anchor_text to use the actual last bullet in the target section before resolution
- Fix: Added _find_section_bounds, _find_last_bullet_in_section, and _correct_anchor_for_section functions for robust section detection
- Refactor: Added domain-specific editor guidance for Rules, Style, and Outline documents with semantic section mapping and automatic placement logic
- Refactor: Migrated style_editing_subgraph and outline_editing_subgraph to use centralized editor operation instructions from shared utilities
- Feature: Rules documents now have semantic section mapping (bride hierarchy → Institutions & Power Dynamics, magic → Magic Systems, etc.)
- Feature: Style documents now have section relationship awareness (POV guidelines affect both Point of View and Narrative Voice sections)
- Feature: Outline documents now have chapter structure templates, 70-beat limit enforcement, and beat placement strategy guidance
- Fix: CRITICAL - Enhanced MISTAKE #7 with multi-line bullet example showing how using "last line of middle bullet" still splits lists
- Fix: Added 4 verification checks for bullet lists including "scan ENTIRE section" and "verify next content is header, not another bullet"
- Fix: Strengthened operation type guidance for insert_after to require "LAST LINE of LAST BULLET" with explicit scan requirement
- Fix: Added explicit warning "Using last line of middle bullet splits the list" to prevent using end of any bullet as anchor
- Fix: CRITICAL - Added MISTAKE #7 "Using middle bullet as anchor" with visual example showing how insert_after splits lists when not using LAST bullet
- Fix: Added explicit guidance "FOR BULLET LISTS" in 3 locations: safety rules, operation types, and verification checklist
- Fix: Enhanced insert_after operation type to warn "Using middle bullet splits the list - new bullets inserted between existing ones!"
- Fix: Added 2 verification checks specifically for bullet list additions (anchor must be LAST bullet, verify no bullets after anchor)
- Fix: CRITICAL - Added explicit START/END markers around file content to prevent LLM from using anchor text from wrong sections (fixes operations defaulting to beginning of document)
- Fix: Added MISTAKE #6 for "anchor text from wrong section" with visual example (prevents using text from style guides/outlines instead of actual file)
- Fix: Enhanced verification checklist to check anchor text EXISTS "between START/END markers" (not from reference docs)
- Fix: Rules subgraph now wraps file content with "=== START OF RULES CONTENT ===" markers for clear text source boundaries
- Fix: CRITICAL - Incorporated fiction agent's battle-tested editor operation guidance into standardized utilities for rock-solid in-editor diffs
- Fix: Added "USE MINIMAL MATCHES" guidance with concrete word-level examples (prevent over-broad original_text that loses adjacent content)
- Fix: Added "WHAT IS VALID ANCHOR TEXT" section with explicit ✅ CORRECT / ❌ WRONG patterns
- Fix: Enhanced verification checklist with "mental Ctrl+F" check and 15 specific validation points
- Fix: Expanded common mistakes to 5 concrete failure scenarios with visual BAD vs GOOD examples
- Fix: Strengthened language from "unreliable" to "will FAIL" to emphasize criticality of text anchors
- Fix: Added "REPLACEMENT TEXT IS COMPLETE" warning with concrete example showing how partial text gets lost
- Fix: CRITICAL - Added explicit "TEXT ANCHORS MANDATORY" guidance to prevent LLMs from generating index-only operations that stomp wrong content
- Refactor: Created centralized editor operation instruction utilities in writing_subgraph_utilities.py with reusable prompt components
- Refactor: Migrated rules_editing_subgraph to use standardized editor operation instructions from shared utilities
- Fix: Enhanced rules agent prompts with explicit "PREFER GRANULAR EDITS" guidance to prevent over-broad replace_range operations that delete unrelated content
- Fix: Added operation validation logging in rules agent to warn when original_text is too large (>300 chars), contains multiple bullet points, or includes section headers
- Fix: Added comprehensive verification checklist and common mistake examples to rules agent prompts
- Feature: Standardized agent response contract with AgentResponse model for consistent response structure across all agents
- Feature: Unified response extraction helpers in grpc_service supporting both legacy and standard formats during migration
- Feature: Rule documenting agent response contract with examples and migration guidelines
- Feature: Added `images` field to AgentResponse contract for structured image data (supports text + image responses)
- Refactor: Migrated reference_agent, fiction_editing_agent, outline_editing_agent, and image_generation_agent to use standard AgentResponse contract
- Fix: Reference agent now formats pattern analysis and insights data into readable lists in chat responses instead of only showing summaries
- Fix: Increased outline agent max_tokens to 250K to allow unlimited operations without truncation
- Fix: Added truncation detection with helpful error messages and detailed logging for incomplete LLM responses
- Fix: Removed artificial operation limits to allow large multi-chapter edits in single request
- Fix: Critical bug in editor operation resolver where undefined variable caused operations to be placed at beginning of file
- Fix: Editor operation resolver now handles None values in start/end positions to prevent type comparison errors
- Fix: Outline agent now correctly inserts subsections (### Status, ### Pacing) immediately after chapter headings instead of at end of chapter
- Fix: Added detailed debug logging to editor operation resolver to diagnose chapter boundary detection issues
- Fix: Improved outline agent error handling for empty LLM responses with better diagnostics
- Fix: Removed spurious frontmatter parsing warnings for simple file path fields
- Documentation: Added comprehensive future email integration guide covering Gmail and Office 365 OAuth implementation
- Fix: Resolved OrgMode editor decoration and folding issues by implementing proper CodeMirror 6 fold/unfold effects with Ctrl+Shift+H keybinding
- Fix: Intent classifier now respects action intent changes (analysis → modification) to prevent routing revisions back to story_analysis_agent
- Fix: Updated btu_hvac formula to handle rooms list and calculate total BTU for multi-room reference documents
- Fix: Updated llm-orchestrator Dockerfile to generate all required gRPC protos including vector_service
- Fix: Installed Chromium and dependencies in tools-service Dockerfile to enable static chart generation via Kaleido
- Update: Increased research agent quick vector search timeout to 5 seconds to accommodate network latency
- Fix: Resolved fiction generation subgraph state preservation bug where generation_context_parts was dropped across nodes
- Fix: Added failed_operations conversion in fiction generation to display unplaceable content in chat sidebar
- Feature: Added context-aware fuzzy matching with auto-correction for fiction agent anchor texts to prevent LLM hallucination errors
- Fix: Resolved message normalization bug where editor_operations buried in metadata were not extracted to top level for display
- Feature: Implemented automatic text-splitting for large editor operations into 8K char chunks at paragraph boundaries to prevent nginx proxy truncation and maintain clean word boundaries
- Fix: Added chunk_index sorting to frontend operation application to ensure text chunks are applied in correct sequence
- Fix: Removed obsolete chunk reversal logic in backend that was causing text chunks to be sent in reverse order
- Fix: Added explicit instructions for fiction agent to use insert_after (not insert_after_heading) when continuing existing chapters to prevent duplication
- Fix: Modified editor operation resolver to prefer matches near cursor position (±10K chars) to ensure edits target the correct chapter when cursor is positioned
- Fix: Resolved DOCX file reading errors in gRPC GetDocumentContent by using DocumentProcessor for binary formats
- Feature: Added automatic location fallback to user ZIP code for weather tools
- Feature: Added date range support for historical weather queries (e.g., "2022-10 to 2024-02")
- Fix: Resolved visualization tool TypeError in orchestrator gRPC client
- Fix: Enhanced chart generation to support static SVG versions via gRPC
- Fix: Fixed gRPC double-abort error in weather service error handling
- Feature: Added "Technical Hyperspace" Deterministic System Modeling Engine with gRPC topology service and NetworkX graph traversal
- Feature: Added Systems Engineering Agent for technical design and failure simulation analysis
- Refactor: Modularized monolithic backend/main.py into domain-specific API routers
- Refactor: Simplified PDF processing to focus on automated text extraction and vectorization
- Cleanup: Decommissioned obsolete manual OCR, coordinate-based PDF editing, and layout segmentation units
- Feature: Moved ePub cover page to the end of the spine to prevent "double cover" in readers
- Fix: Enhanced ePub cover resolution to support relative paths in frontmatter and database lookups
- Fix: Resolved XML syntax error in ePub cover page generation
- Update: Created Org-Mode enhancement roadmap in docs/dev-notes
- Fix: Resolved issue where 'Filter by Tag' in All TODOs view was empty by correcting data property access
- Update: Centralized all weather intelligence logic into dedicated gRPC Tools Service
- Refactor: Migrated Weather Agent and Status Bar API to use gRPC weather service, eliminating redundant logic
- Feature: Added real-time moon phase and meteorological metadata to central weather tool
- Feature: Extracted dedicated gRPC Tools Service container from backend monolith
- Update: Reconfigured LLM Orchestrator to communicate directly with Tools Service via gRPC
- Refactor: Trimmed backend container size by moving tool logic to microservice
- Feature: Added image import functionality for generated images - users can now import images directly into document library folders
- Feature: Automatic cleanup of generated images when conversations are deleted - imported images are preserved, non-imported images are removed
- Fix: Implemented "Smart Validation" for editor diffs to prevent invalidation during full-document syncs
- Fix: Resolved race condition and network-sync related diff invalidation in the live editor
- Fix: Resolved race condition where rapid acceptance of multiple live diffs caused remaining diffs to disappear
- Fix: Prevented live edit diffs from disappearing when accepting multiple changes in rapid succession
- Fix: Resolved frontend build error due to missing variable definition in MessagingContext
- Fix: Resolved message duplication and unread count persistence issues in real-time chat
- Fix: Resolved issue where new rooms and initial messages failed to appear for recipients in real-time
- Fix: Resolved issue where user "offline" status failed to broadcast in real-time
- Fix: Resolved issue where users remained "online" after logging out or closing their browser
- Fix: Improved WebSocket headcount logic to correctly track multiple simultaneous connections per user
- Fix: Resolved issue where unread message counts would reappear after a page refresh
- Fix: Resolved issue with messaging presence indicators getting stuck or failing on refresh
- Fix: Resolved issue where messaging notifications failed to update until the drawer was opened
- Fix: Resolved circular RLS dependency in messaging system causing rooms to vanish on refresh
- Fix: Corrected room display name calculation to correctly identify other participants
- Feature: Added detailed logging for outline chapter extraction in fiction agent
- Fix: Improved forward-looking outline context for new manuscripts in fiction generator
- Refactor: Established standard agent handoff pattern using shared_memory for clean inter-agent data passing
- Update: Simplified intent classification to trust LLM semantic understanding over pattern matching
- Fix: Research agent now receives reference document context when delegated by reference agent
- Fix: Added 'reference' to allowed editor types in frontend for proper reference agent routing
- Fix: Backend now accepts reference documents even if not editable for reference_agent analysis
- Refactor: Removed unnecessary short-circuit routing hack, using normal intent classification
- Feature: Added in-editor suggestion capabilities for editor-interactive agents (fiction, outline, electronics)
- Feature: Media service integrations in progress (SubSonic, Audiobookshelf, Deezer)
- Fix: Fiction agent continuity file creation now uses same folder resolution as electronics agent (folder_id or folder_path from canonical_path)
- Fix: Enhanced cursor detection with complete gRPC proto support for fiction editing agent
- Fix: Chat message copy now preserves markdown formatting as rich text (HTML) while keeping raw markdown syntax for plain text editors
- Feature: Added Dictionary Agent with short-circuit routing for "/define" queries (instant lexicographic lookups)
- Update: Changed dictionary agent trigger from "define:" to "/define" command format
- Fix: Resolved conversation ID mismatch causing 403 errors when accessing conversations from checkpoint list
- Feature: Added universal DocumentEditBatch system for atomic multi-edit operations
- Feature: Added intelligent reference file creation to general and electronics agents (>1500 char threshold)
- Refactor: Migrated electronics_agent to use batch editing for atomic, efficient document updates
- Update: Enhanced both project agents with automatic file creation and frontmatter management
- Fix: Resolved FictionEditingState NameError by using forward references for type-safe state access helpers
- Fix: Improved type safety in fiction editing agent with Pydantic model conversion for structured_edit and continuity_state
- Fix: Enhanced operation resolution in fiction editing agent with better anchor text matching and error handling
- Fix: Active editor frontmatter now persists correctly during typing - removed re-parsing that was overwriting cached frontmatter with empty data

### Bug Fixes
- Fix: Resolved KeyError in electronics agent when user approves pending save operations
  - Root cause: Conditional edges from analyze_intent node missing 'save' and 'maintenance' destinations
  - Added missing routing paths for approval flow resumption

### Conversation History Persistence Fix
- **Fix**: Resolved critical conversation history issue where LLM orchestrator was treating every request as a new conversation
  - Root cause: Backend was not loading conversation state from database before sending to LLM orchestrator
  - Added `_load_conversation_state()` function to retrieve `primary_agent_selected` and conversation context
  - Intent classifier now properly maintains agent continuity between requests
  - Conversation history now persists correctly across LLM interactions
- **Fix**: LLM orchestrator agents now properly save conversations to LangGraph checkpoints matching backend behavior
  - Root cause: Agents were not adding current user query to messages before workflow invocation
  - Root cause: Agents were not adding assistant responses to messages after generation
  - Added `_prepare_messages_with_query()` helper to BaseAgent for consistent message preparation
  - Added `_add_assistant_response_to_messages()` helper to BaseAgent for checkpoint persistence
  - Updated all critical agents (chat, electronics, data_formatting, help, content_analysis) to use helpers
  - User queries and assistant responses now properly saved to PostgreSQL checkpoints
  - Created test script to verify checkpoint persistence (`test_checkpoint_persistence.py`)

### Architectural Refactoring - Vector Service Only (No Fallback)
- **Breaking**: Committed fully to Vector Service architecture (no fallback to legacy EmbeddingManager)
  - All embedding generation routes through Vector Service microservice (gRPC)
  - EmbeddingManager replaced with deprecation stub (raises NotImplementedError)
  - Removed 300+ lines of duplicate embedding generation logic
  - Single source of truth: Vector Service for all embeddings
- **Refactor**: Simplified EmbeddingServiceWrapper to Vector Service only
  - Removed fallback logic and USE_VECTOR_SERVICE flag checks
  - Always uses Vector Service for embedding generation
  - Always uses VectorStoreService for storage/search
  - Reduced from 330 lines to 350 lines (cleaner, simpler)
- **Refactor**: Updated ResilientEmbeddingManager to use EmbeddingServiceWrapper
  - No longer directly depends on EmbeddingManager
  - Uses embedding_service for generation, vector_store for storage

### Architectural Refactoring - Vector Storage Separation
- **Feature**: Created VectorStoreService for clean separation of concerns
  - New service handles all vector database operations (Qdrant)
  - Collection management, point insertion, vector search, deletion
  - Foundation for multi-backend support (Milvus, Elasticsearch)
- **Refactor**: Updated search tools to use new architecture
  - Tools generate embeddings then search via VectorStoreService
- **Breaking**: Removed unused ParallelEmbeddingManager dead code (710 lines)
- **Breaking**: Removed FreeFormNotesService and all related code including database table (1001 lines total)
- Refactor: Query expansion extracted to standalone QueryExpansionService with dedicated LangGraph tool
- Refactor: Removed automatic query expansion from EmbeddingManager (agents now explicitly control expansion)
- Refactor: Removed unused ParallelEmbeddingManager dead code
- Refactor: Removed FreeFormNotesService and all related code including database table (unused feature with no UI)

## [0.1.0] - 2025-11-13

### Initial Release
A comprehensive AI-powered personal workspace platform featuring 25+ specialized agents for knowledge management, creative writing, data workspaces, collaboration, and productivity - all controlled through natural language.

#### Core Features
- **LangGraph Multi-Agent System**: 25+ specialized agents with PostgreSQL state persistence
- **Document Management**: RAG with vector search (Qdrant) and knowledge graphs (Neo4j)
- **Data Workspaces**: Dedicated microservice with PostgreSQL for custom databases, data import (CSV/JSON/Excel), and table management
- **Real-time Collaboration**: Messaging system with presence indicators and optional encryption
- **Org-mode Integration**: WebDAV sync with dedicated inbox and project agents
- **RSS Feed Management**: Background polling and article import with dedicated agent
- **Creative Writing Suite**: Fiction editing, proofreading, character development, and outline editing agents
- **Knowledge Integration**: Entertainment knowledge base
- **Specialized Agents**: Weather, image generation, audio transcription, coding assistance, research, fact-checking, and more
- **Microservices Architecture**: Docker Compose deployment with vector-service, data-service, and llm-orchestrator

#### Technical Stack
- Backend: Python, FastAPI, LangGraph, Celery, gRPC
- Frontend: React, Material-UI, WebSockets
- Databases: PostgreSQL (main + data workspaces), Qdrant (vectors), Neo4j (knowledge graph)
- Infrastructure: Docker Compose, microservices architecture
- AI: OpenRouter/OpenAI integration with structured Pydantic outputs



